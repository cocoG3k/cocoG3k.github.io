---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const diaryEntries = (await getCollection("diary")).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
);
const latestEntry = diaryEntries[0];

const formatDate = (date: Date) => date.toISOString().split("T")[0].replace(/-/g, ".");
---

<BaseLayout
  title="cocoG学"
  description="真髄はここに"
>
  <main>
    <header>
      <div class="brand">
        <a href="/" aria-label="cocoG">
          <img src="/cocog-logo.png" alt="cocoG" />
        </a>
      </div>
      <nav>
        <a href="/diary">記事一覧</a>
      </nav>
    </header>

    <section class="hero" id="intro">
      <div>
        <h1>cocoG学</h1>
        <p>
          真髄はここに
        </p>
        <div class="hero-actions">
          <a
            class="button primary"
            href={latestEntry ? `/diary/${latestEntry.slug}` : '/diary'}
          >
            最新の記録を見る
          </a>
          <a class="button" href="/diary">記事一覧へ</a>
        </div>
      </div>
      <div class="card">
        <h3>近頃の一言</h3>
        <p>
          堅揚げポテトの値上げ、効く
        </p>
      </div>
    </section>

    <section id="diary">
      <h2 class="section-title">最新記事</h2>
      <div class="diary-list diary-card-grid">
        {diaryEntries.map((entry) => (
          <a class="diary-entry-link" href={`/diary/${entry.slug}`}>
            <article class="diary-entry diary-card">
              <span class="entry-date">{formatDate(entry.data.date)}</span>
              <h3>{entry.data.title}</h3>
              <p>{entry.data.description}</p>
            </article>
          </a>
        ))}
      </div>
    </section>

    <footer>
      <div class="footer-card">
        <span class="footer-label">GitHub</span>
        <a href="https://github.com/cocog3k" target="_blank" rel="noreferrer">
          https://github.com/cocog3k
        </a>
      </div>
    </footer>
    <button type="button" class="secret-entry" aria-label="Admin access"></button>
  </main>

  <style>
    .secret-entry {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: none;
      background: rgba(127, 159, 139, 0.35);
      opacity: 0.08;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    .secret-entry:hover {
      opacity: 0.22;
    }
  </style>

  <script>
    const secretButton = document.querySelector(".secret-entry");

    secretButton?.addEventListener("click", async () => {
      const token = window.prompt("管理トークンを入力してください");
      if (!token) return;

      try {
        const response = await fetch("/api/auth", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token }),
        });

        if (!response.ok) {
          alert("認証に失敗しました。");
          return;
        }

        window.location.href = "/admin/editor";
      } catch (error) {
        console.error(error);
        alert("認証処理でエラーが発生しました。");
      }
    });
  </script>
</BaseLayout>
