---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection, getEntryBySlug } from "astro:content";

export async function getStaticPaths() {
  const entries = await getCollection("diary");
  return entries.map((entry) => ({ params: { slug: entry.slug } }));
}

const { slug } = Astro.params;
const entry = await getEntryBySlug("diary", slug);
const diaryEntries = (await getCollection("diary")).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
);

if (!entry) {
  throw new Error(`Diary entry not found: ${slug}`);
}

const { Content } = await entry.render();
const formatDate = (date: Date) => date.toISOString().split("T")[0].replace(/-/g, ".");
const currentIndex = diaryEntries.findIndex((diaryEntry) => diaryEntry.slug === entry.slug);
const nextEntry = currentIndex > 0 ? diaryEntries[currentIndex - 1] : undefined;
const prevEntry =
  currentIndex >= 0 && currentIndex < diaryEntries.length - 1
    ? diaryEntries[currentIndex + 1]
    : undefined;
---

<BaseLayout title={`cocoG | ${entry.data.title}`} description={entry.data.description}>
  <main>
    <header>
      <div class="brand">
        <a href="/" aria-label="cocoG">
          <img src="/cocog-logo.png" alt="cocoG" />
        </a>
      </div>
      <nav>
        <a href="/diary">記事一覧</a>
      </nav>
    </header>

    <section class="hero" style="padding-bottom: 32px;">
      <div>
        <span class="entry-date">{formatDate(entry.data.date)}</span>
        <h1>{entry.data.title}</h1>
        <p>{entry.data.description}</p>
        <div class="entry-meta">
          <div class="entry-meta-group">
            <span class="entry-meta-label">Date</span>
            <span>{formatDate(entry.data.date)}</span>
          </div>
          <div class="entry-meta-group">
            <span class="entry-meta-label">Tags</span>
            <div class="tag-list">
              {(entry.data.tags ?? ["未設定"]).map((tag) => (
                <span class="tag">{tag}</span>
              ))}
            </div>
          </div>
        </div>
        <div class="hero-actions">
          <a class="button" href="/diary">一覧へ戻る</a>
        </div>
      </div>
    </section>

    <article class="card prose" style="margin-top: 24px;">
      <Content />
    </article>
    <section class="card" style="margin-top: 24px;">
      <div class="giscus"></div>
      <script
        src="https://giscus.app/client.js"
        is:inline
        data-repo="cocoG3k/cocoG3k.github.io"
        data-repo-id="R_kgDOQ9VG0w"
        data-category="General"
        data-category-id="DIC_kwDOQ9VG084C1UDu"
        data-mapping="url"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="ja"
        crossorigin="anonymous"
        async
      ></script>
    </section>

    {(nextEntry || prevEntry) && (
      <section class="nav-links" style="margin-top: 48px;">
        {prevEntry && (
          <a class="card nav-link" href={`/diary/${prevEntry.slug}`} style={{ marginRight: 'auto' }}>
            <span class="nav-label">前の記事</span>
            <span class="nav-title">{prevEntry.data.title}</span>
            <span class="nav-date">{formatDate(prevEntry.data.date)}</span>
          </a>
        )}
        {nextEntry && (
          <a class="card nav-link" href={`/diary/${nextEntry.slug}`} style={{ marginLeft: 'auto' }}>
            <span class="nav-label">次の記事</span>
            <span class="nav-title">{nextEntry.data.title}</span>
            <span class="nav-date">{formatDate(nextEntry.data.date)}</span>
          </a>
        )}
      </section>
    )}

    <footer>
      <span>© 2026 cocoG. Written with calm.</span>
      <span>Tokyo / Home desk</span>
    </footer>
  </main>
</BaseLayout>
